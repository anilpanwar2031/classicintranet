from django.shortcuts import render, redirect, HttpResponse
from .models import Quotation, Product, Section, Subsection
# , Product, Quotation_item, Client, Section
from django.contrib.auth.models import User
from django.http import JsonResponse
from django.db.models import Q
from datetime import datetime
from .models import quotationstatus


def grandtotal(sections):
    gt = 0
    print("No of Sections : ", len(sections))
    for s in sections:
        print("Section id , Name ", s.id, " ", s.name)
        try:
            pds = Section.objects.filter(id=s.id).values('product__selling_price')
            for pd in pds:
                print("Price : ", pd["product__selling_price"])
                gt = gt + pd["product__selling_price"]
        except:
            pass
    print("Section Grant Total : ", gt)

    for s in sections:
        try:
            subs = Subsection.objects.filter(section=s.id)
            print("No of Subsections : ", len(subs))
            for sub in subs:
                print("Sub Section id , Name ", sub.id, " ", sub.name)
                try:
                    pds = Subsection.objects.filter(id=sub.id).values('product__selling_price')
                    for pd in pds:
                        print("Price : ", pd["product__selling_price"])
                        gt = gt + pd["product__selling_price"]
                except:
                    pass
        except:
            pass
    print("Grand Total : ", gt)
    print("quotation status", quotationstatus)
    for qs in quotationstatus:
        print(qs[1])
    return gt


def index(request):
    return render(request, 'index.html')


def dashboard(request):
    quots = Quotation.objects.all().count()
    products = Product.objects.all().count()
    users = User.objects.all().count()
    active = 'dashboard'
    return render(request, "dashboard.html", {"quots": quots, "products": products, "users": users, "active": active})


def quotation(request):
    quots = Quotation.objects.all()
    return render(request, "quotation.html", {"quots": quots})


def quotdetail(request, pk):
    print("\n")
    print("\n")
    print("pk ", pk)
    products = Product.objects.all()
    quot = Quotation.objects.get(id=pk)
    # print("Quotation ", type(quot))
    sections = Section.objects.filter(quotation=pk)
    prods = []
    gt = 0
    # gt = grandtotal(sections)
    print("Sections ", sections)

    # for s in sections:

    data = [{'id': s.id, 'name': s.name, 'quotation': s.quotation.id, 'product': s.product} for s in sections]
    print(data)
    print("data name ", data[0]["name"])

    # data = []
    # for s in sections:
    #     section = {}
    #     section['id'] = s.id
    #     section['name'] = s.name
    #     section['quotation'] = s.quotation.id
    #     product = s.product.id
    #     print("PrRr", product)
    #     product = []
    #
    #     data.append(section)
    # print("DATA", data)






    context = {'products': products, 'quot': quot, 'grandtotal': gt, "sections": sections, "quotationstatus":quotationstatus}
    return render(request, "quotationdetail.html", context)


def products(request):
    prods = Product.objects.all()
    return render(request, "product.html", {"prods": prods})


def qsearch(request):
    if request.method == 'POST':
        search = request.POST['search'].lower()
        print("Search = = ", search)

        queryset = Quotation.objects.filter(Q(quot_no__icontains=search) | Q(name__icontains=search) | Q(quot_status__icontains=search) | Q(market_seg__icontains=search))
        data = [{'id': d.id, 'quot_no': d.quot_no, 'name': d.name, 'quot_status': d.get_quot_status_display(), 'market_seg': d.market_seg,
                 'created_at': d.created_at.strftime("%b %d,%Y") + " | " + d.created_at.strftime("%H:%M %p").lower(), 'created_by': d.created_by.email} for d in queryset]

        for d in queryset:
            print("datetime", d.created_at.strftime("%b %d,%Y") + " | " + d.created_at.strftime("%H:%M %p").lower())
        # print("Data1 = ", data)
        return JsonResponse(data, safe=False)


def psearch(request):
    if request.method == 'POST':
        search = request.POST['search'].lower()
        print("Search = = ", search)

        queryset = Product.objects.filter(Q(name__icontains=search) | Q(description__icontains=search)).values()
        data = list(queryset)
        print("Data = ", data)
        return JsonResponse(data, safe=False)
